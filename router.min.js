var _=require("underscore"),fs=require("fs");module.exports=function(e,a,t){function i(e,a){a.render("index",{pageData:{title:"museo",images:t.getImages()}})}function n(e,a){a.render("capture",{pageData:{title:"snapshot"}})}function d(e,a){a.render("feedback",{pageData:{title:"feedback"}})}function o(e,a){var t=e.body.path;e.body.imgBase64=e.body.imgBase64.replace(/^data:image\/jpeg+;base64,/,""),e.body.imgBase64=e.body.imgBase64.replace(/ /g,"+");var i=Math.round((new Date).getTime()/1e3),t="public/images/"+t+"/"+i+".jpg";fs.writeFile(t,e.body.imgBase64,"base64",function(e){console.info("write new file to "+t)}),a.json(200,{message:"New picture received"})}function r(e,t){data={images:{}};for(key in e.body)(match=key.match(/image-(\d+)/))?data.images[match[1]]=e.body[key]:data[key]=e.body[key];return console.log("data",data),_.isUndefined(data.legend)||_.isEmpty(data.legend.trim())?t.json(400,{error:"Legend is invalid"}):(a.sockets.emit("incomingLine",data),void t.json(200,{message:"New line received"}))}function s(e){var a=e.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/),t={};return 3!==a.length?new Error("Invalid input string"):(t.type=a[1],t.data=new Buffer(a[2],"base64"),t)}e.get("/",i),e.get("/capture",n),e.get("/feedback",d),e.post("/newline",r),e.post("/newImage",o)};