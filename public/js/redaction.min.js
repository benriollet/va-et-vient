jQuery(document).ready(function(e){function t(e){if(console.log(String.fromCharCode(e.which)),e.ctrlKey||e.metaKey)switch(String.fromCharCode(e.which)){case" ":e.preventDefault(),onSendCapture()}}function n(){x=b.socket.sessionid,console.log("Connected "+x)}function i(e){console.log("incomingLine",e),f(e)}function o(t){console.log("new image :: data",t);var n=e('#editor .images[columnname="'+t.column+'"]'),i=e('#editor .images[columnname="'+t.column+'"] .thumbs'),o=e('#editor .images[columnname="'+t.column+'"] .thumbslegends'),a=e('#editor .images[columnname="'+t.column+'"] select'),s=e('#editor .images[columnname="'+t.column+'"] input[type="range"]'),l=Math.floor(i.find("img:last").attr("index"))+1;isNaN(l)&&(l=0),console.log("index after",l),n.addClass("new-image"),$img=e("<img>").addClass("thumb").attr("index",l).attr("alt",t.note.text).attr("src",t.src),$lgd=e("<p>").addClass("thumblegend").attr("index",l).html(t.note.text),0!=l&&($img.hide(),$lgd.hide()),i.append($img),o.append($lgd);var c=setTimeout(function(){n.removeClass("new-image"),clearTimeout(c)},5e3);a.append(e("<option>").attr("index",l).attr("value",t.note.time+"_"+t.ts+".jpg").html(t.note.time+"_"+t.ts+".jpg")),s.attr("max",l+1)}function a(e){console.log("Unable to connect to server",e)}function s(t){console.log(t);var n=e(t.currentTarget).attr("columnName");console.log("columnName",n),e("textarea#caption").html(e('.images[columnName="'+n+'"] .thumbs img.on').attr("alt"))}function l(){var t={};e("#editor .images").each(function(n){var i;i=e(this).hasClass("selected")?e(this).find('option[selected="selected"]').val():!1,t[e(this).attr("columnName")]=i});var n={session:app.session,time:(new Date).getTime(),caption:v(e("#caption").val()),images:t};console.log(n),e("#caption").val(""),e("#editor .btn[data-toggle].active").trigger("click"),e('#editor input[type="range"]').each(function(t,n){var i=e(this).attr("max");r(e(this).parents(".images"),i-1)}),b.emit("newLine",n)}function c(t){console.log("mousewheel deltaY",t.deltaY);var n;t.deltaY>0?n=e(this).find("img:visible").next().size()?e(this).find("img:visible").next():e(this).find("img:first-child"):t.deltaY<0&&(n=e(this).find("img:visible").prev().size()?e(this).find("img:visible").prev():e(this).find("img:last-child")),r(e(this).parents(".images"),parseInt(n.attr("index")))}function d(t){console.log("onImageRangeChange"),r(e(this).parents(".images"),e(this).val()-1)}function r(t,n){t.find("img, .thumblegend").hide().removeClass("on"),e('img[index="'+n+'"], .thumblegend[index="'+n+'"]',t).show().addClass("on"),e("option",t).removeAttr("selected"),e('select option[index="'+n+'"]',t).attr("selected",!0),e('input[type="range"]',t).val(n+1)}function g(){console.log("onToggleImage"),e(this).parents(".images").toggleClass("selected"),e("span",e(this)).toggleClass("glyphicon-eye-close").toggleClass("glyphicon-eye-open")}function m(){e(this).is("#bold")?e("#italic").removeClass("active"):e("#bold").removeClass("active")}function t(e){switch(e.key){case"Up":case"Right":case"Down":case"Left":h(e)}}function h(t){t.preventDefault();var n=e("#recordedlines .images.highlight").length>0?e("#recordedlines .images.highlight:first"):null;if(null===n)var i=0,o=0;else{var i=n.index(),o=n.parents(".record").index();switch(t.key){case"Up":o--;break;case"Right":i++;break;case"Down":o++;break;case"Left":i--}}u(i,o)}function u(t,n){console.log("x: ",t),console.log("y: ",n),e(".highlight").removeClass("highlight"),e("#recordedlines .record:nth-child("+n+") .images:nth-child("+t+")").addClass("highlight")}function p(){e(".thumbs img:first-child, .thumbslegends p:first-child").addClass("on")}function f(t){console.log(t);var n=e("<article>").addClass("record row").append(e("<p>").addClass("legend col-xs-3").html(t.caption));for(folder in t.images){var i=e("<div>").addClass("col-xs-3"),o="/"+t.session+"/"+folder+"/"+t.images[folder];t.images[folder]&&i.append(e("<img>").addClass("thumb").attr("src",o)),n.append(i)}n.appendTo("#content")}function v(t){return e("#bold").hasClass("active")?t="**"+t+"**":e("#italic").hasClass("active")&&(t="*"+t+"*"),t}var C=document.domain,b=io.connect(C),x="";b.on("connect",n),b.on("incomingLine",i),b.on("error",a),b.on("newImage",o),e("#send").on("click",l),e(".copyCaption").on("click",s),e(document).on("keypress",t),e("#editor .thumbs, #editor .thumbslegends").on("mousewheel",c),e('#editor input[type="range"]').on("change",d),e("#editor .btn#bold, #editor .btn#italic").on("click",m),e("#editor .images .btn[data-toggle]").on("click",g),p()});