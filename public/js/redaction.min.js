jQuery(document).ready(function(e){function t(){x=b.socket.sessionid,console.log("Connected "+x)}function i(e){console.log("incomingLine",e),f(e)}function n(t){console.log("new image :: data",t);var i=e('#editor .images[columnname="'+t.column+'"]'),n=e('#editor .images[columnname="'+t.column+'"] .thumbs'),o=e('#editor .images[columnname="'+t.column+'"] select'),a=e('#editor .images[columnname="'+t.column+'"] input[type="range"]'),s=Math.floor(n.find("img:last").attr("index"))+1;i.addClass("new-image"),n.append(e("<img>").addClass("thumb").attr("index",s).attr("alt",t.note.text).attr("src",t.src).hide());var l=setTimeout(function(){i.removeClass("new-image"),clearTimeout(l)},5e3);o.append(e("<option>").attr("index",s).attr("value",t.note.time+"_"+t.ts+".jpg").html(t.note.time+"_"+t.ts+".jpg")),a.attr("max",s+1)}function o(e){console.log("Unable to connect to server",e)}function a(t){console.log(t);var i=e(t.currentTarget).attr("columnName");console.log("columnName",i),e("textarea#caption").html(e('.images[columnName="'+i+'"] .thumbs img.on').attr("alt"))}function s(){var t={};e("#editor .images").each(function(i){var n;n=e(this).hasClass("selected")?e(this).find('option[selected="selected"]').val():!1,t[e(this).attr("columnName")]=n});var i={session:app.session,time:(new Date).getTime(),caption:v(e("#caption").val()),images:t};console.log(i),e("#caption").val(""),e("#editor .btn[data-toggle].active").trigger("click"),e('#editor input[type="range"]').each(function(t,i){var n=e(this).attr("max");r(e(this).parents(".images"),n-1)}),b.emit("newLine",i)}function l(t){console.log("mousewheel deltaY",t.deltaY);var i;t.deltaY>0?i=e(this).find("img:visible").next().size()?e(this).find("img:visible").next():e(this).find("img:first-child"):t.deltaY<0&&(i=e(this).find("img:visible").prev().size()?e(this).find("img:visible").prev():e(this).find("img:last-child")),r(e(this).parents(".images"),parseInt(i.attr("index")))}function c(t){console.log("onImageRangeChange"),r(e(this).parents(".images"),e(this).val()-1)}function r(t,i){t.find("img").hide().removeClass("on"),e('img[index="'+i+'"]',t).show().addClass("on"),e("option",t).removeAttr("selected"),e('select option[index="'+i+'"]',t).attr("selected",!0),e('input[type="range"]',t).val(i+1)}function d(){console.log("onToggleImage"),e(this).parents(".images").toggleClass("selected"),e("span",e(this)).toggleClass("glyphicon-eye-close").toggleClass("glyphicon-eye-open")}function g(){e(this).is("#bold")?e("#italic").removeClass("active"):e("#bold").removeClass("active")}function m(e){switch(e.key){case"Up":case"Right":case"Down":case"Left":h(e)}}function h(t){t.preventDefault();var i=e("#recordedlines .images.highlight").length>0?e("#recordedlines .images.highlight:first"):null;if(null===i)var n=0,o=0;else{var n=i.index(),o=i.parents(".record").index();switch(t.key){case"Up":o--;break;case"Right":n++;break;case"Down":o++;break;case"Left":n--}}u(n,o)}function u(t,i){console.log("x: ",t),console.log("y: ",i),e(".highlight").removeClass("highlight"),e("#recordedlines .record:nth-child("+i+") .images:nth-child("+t+")").addClass("highlight")}function p(){e(".thumbs img:first-child").addClass("on")}function f(t){console.log(t);var i=e("<article>").addClass("record row").append(e("<p>").addClass("legend col-xs-3").html(t.caption));for(folder in t.images){var n=e("<div>").addClass("col-xs-3"),o="/"+t.session+"/"+folder+"/"+t.images[folder];t.images[folder]&&n.append(e("<img>").addClass("thumb").attr("src",o)),i.append(n)}i.appendTo("#content")}function v(t){return e("#bold").hasClass("active")?t="**"+t+"**":e("#italic").hasClass("active")&&(t="*"+t+"*"),t}var C=document.domain,b=io.connect(C),x="";b.on("connect",t),b.on("incomingLine",i),b.on("error",o),b.on("newImage",n),e("#send").on("click",s),e(".copyCaption").on("click",a),e("#editor .thumbs").on("mousewheel",l),e('#editor input[type="range"]').on("change",c),e("#editor .btn#bold, #editor .btn#italic").on("click",g),e("#editor .images .btn[data-toggle]").on("click",d),p()});